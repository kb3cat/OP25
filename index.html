<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OP25 â€” Talkgroups</title>

<style>
:root{
  --bg:#ffffff;
  --text:#111111;
  --muted:#666666;
  --border:#d0d0d0;
  --header:#f4f4f4;
}
body{
  margin:20px;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
h1{
  margin:0 0 6px 0;
  font-size:22px;
}
.sub{
  font-size:13px;
  color:var(--muted);
  margin-bottom:15px;
}
.controls{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
input{
  padding:8px 10px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:14px;
  width:260px;
}
button{
  padding:8px 12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
}
button:hover{
  background:#f6f6f6;
}
.table-wrap{
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}
table{
  width:100%;
  border-collapse:collapse;
}
thead th{
  background:var(--header);
  padding:10px;
  text-align:left;
  font-size:12px;
  color:var(--muted);
  cursor:pointer;
  user-select:none;
}
tbody td{
  padding:10px;
  border-top:1px solid var(--border);
  font-size:13px;
}
tbody tr:hover{
  background:#fafafa;
}
.right{
  text-align:right;
}
.mono{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace;
  font-size:12px;
}
.footer{
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>

<h1>OP25 Talkgroups</h1>
<div class="sub">Live view of <span class="mono">talkgroups_state.csv</span></div>

<div class="controls">
  <input id="search" placeholder="Search talkgroups..." />
  <button id="refresh">Refresh</button>
</div>

<div class="table-wrap">
  <table>
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<div class="footer" id="footer"></div>

<script>
(() => {

const FILE = "talkgroups_state.csv";
let headers = [];
let rows = [];
let sortIndex = 0;
let sortDir = "asc";

const $ = id => document.getElementById(id);

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

function parseCSV(text){
  const lines = text.trim().split("\n");
  return lines.map(line => {
    const result = [];
    let current = "";
    let inQuotes = false;

    for(let i=0;i<line.length;i++){
      const char = line[i];
      const next = line[i+1];

      if(inQuotes){
        if(char === '"' && next === '"'){
          current += '"';
          i++;
        } else if(char === '"'){
          inQuotes = false;
        } else {
          current += char;
        }
      } else {
        if(char === '"'){
          inQuotes = true;
        } else if(char === ","){
          result.push(current);
          current = "";
        } else {
          current += char;
        }
      }
    }
    result.push(current);
    return result;
  });
}

async function loadCSV(){
  const res = await fetch(FILE + "?_=" + Date.now(), {cache:"no-store"});
  const text = await res.text();
  const parsed = parseCSV(text);
  headers = parsed.shift() || [];
  rows = parsed;
}

function renderHeader(){
  $("thead").innerHTML = `
    <tr>
      ${headers.map((h,i)=>`<th data-i="${i}">${escapeHtml(h)}</th>`).join("")}
    </tr>
  `;

  document.querySelectorAll("th").forEach(th=>{
    th.addEventListener("click", ()=>{
      const idx = Number(th.dataset.i);
      if(sortIndex === idx){
        sortDir = sortDir === "asc" ? "desc" : "asc";
      } else {
        sortIndex = idx;
        sortDir = "asc";
      }
      render();
    });
  });
}

function render(){
  const query = $("search").value.toLowerCase();

  let view = rows.filter(r => r.join(" ").toLowerCase().includes(query));

  const dir = sortDir === "asc" ? 1 : -1;

  view.sort((a,b)=>{
    const va = a[sortIndex] ?? "";
    const vb = b[sortIndex] ?? "";

    const na = Number(va);
    const nb = Number(vb);

    if(!isNaN(na) && !isNaN(nb)){
      return (na - nb) * dir;
    }

    return va.localeCompare(vb, undefined, {numeric:true}) * dir;
  });

  $("tbody").innerHTML = view.map(r=>`
    <tr>
      ${r.map(cell=>{
        const isNum = /^\d+$/.test(cell.trim());
        return `<td class="${isNum ? 'right mono' : ''}">${escapeHtml(cell)}</td>`;
      }).join("")}
    </tr>
  `).join("");

  $("footer").innerHTML = `
    Total rows: <span class="mono">${rows.length}</span> |
    Showing: <span class="mono">${view.length}</span> |
    Sort: <span class="mono">${headers[sortIndex]} (${sortDir})</span>
  `;
}

async function init(){
  $("search").addEventListener("input", render);
  $("refresh").addEventListener("click", async()=>{
    await loadCSV();
    render();
  });

  await loadCSV();
  renderHeader();
  render();
}

init();

})();
</script>

</body>
</html>

